version: '3.8'

services:
  # --- Spotify Scrobbler Backend ---
  backend:
    container_name: spotify_scrobbler_backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - PUID=1000
      - PGID=10
      - TZ=Europe/Vienna
      - LASTFM_API_KEY=${LASTFM_API_KEY}
      - LASTFM_API_SECRET=${LASTFM_API_SECRET}
      - LASTFM_USER=${LASTFM_USER}
    ports:
      - "8000:8000"
    volumes:
      - type: bind
        source: /volume1/docker/data/Music
        target: /app/downloads
        bind:
          create_host_path: true
      - type: bind
        source: /volume1/docker/appdata/spotify-scrobbler/data
        target: /app/data
        bind:
          create_host_path: true
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: "512M"
        reservations:
          memory: "128M"

  # --- Spotify Scrobbler Frontend ---
  frontend:
    container_name: spotify_scrobbler_frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3001:80"
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: "256M"
        reservations:
          memory: "64M"
